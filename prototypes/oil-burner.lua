--[[ RECIPE TEMPLATE
  {
    fluid = "",
    flue_ratio = 0,
    flue_replacement = "",
    fuel_efficiency = 0,
    emissions_multiplier = 0,
  },
]]

recipes = {
  {
    fluid = "kerosene",
    flue_ratio = 1.5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "diesel",
    flue_ratio = 1.5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "pressured-hydrogen",
    flue_ratio = 0,
    fuel_efficiency = 1,
    emissions_multiplier = 0
  },
  {
    fluid = "gasoline",
    flue_ratio = 1.2,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "tall-oil",
    flue_ratio = 5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "purified-syngas",
    flue_ratio = 0,
    fuel_efficiency = 1,
    emissions_multiplier = 0.5
  },
  {
    fluid = "propene",
    flue_ratio = 0.5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "processed-light-oil",
    flue_ratio = 1,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "petroleum-gas",
    flue_ratio = 0.5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "methanol",
    flue_ratio = 1,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "hot-syngas",
    flue_ratio = 2,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "fatty-acids",
    flue_ratio = 5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "ethylene",
    flue_ratio = 0.5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "btx",
    flue_ratio = 2,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "bitumen",
    flue_ratio = 10,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "benzene",
    flue_ratio = 1,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "light-oil",
    flue_ratio = 2,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "methane",
    flue_ratio = 0.8,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "heavy-oil",
    flue_ratio = 4,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "fuel-oil",
    flue_ratio = 4,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "bio-oil",
    flue_ratio = 4,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "coke-oven-gas",
    flue_ratio = 1.5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "acetylene",
    flue_ratio = 0.4,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "naphtha",
    flue_ratio = 0.6,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "scrude",
    flue_ratio = 2.5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "refsyngas",
    flue_ratio = 0.5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "pure-natural-gas",
    flue_ratio = 0.25,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "outlet-gas-01",
    flue_ratio = 2.5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "outlet-gas-02",
    flue_ratio = 1.5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "outlet-gas-03",
    flue_ratio = 1,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "outlet-gas-04",
    flue_ratio = 0.5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "high-ash-fines",
    flue_ratio = 5,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "condensed-distillate",
    flue_ratio = 1,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "syngas",
    flue_ratio = 0.8,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "stripped-distillate",
    flue_ratio = 1.2,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "purified-natural-gas",
    flue_ratio = 0.2,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "medium-distillate",
    flue_ratio = 1.2,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "low-distillate",
    flue_ratio = 2,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "high-distillate",
    flue_ratio = 0.8,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "carbolic-oil",
    flue_ratio = 1,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "aromatics",
    flue_ratio = 0.3,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "refined-natural-gas",
    flue_ratio = 0.2,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "naphthalene-oil",
    flue_ratio = 0.3,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "anthracene-oil",
    flue_ratio = 1.3,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "tar",
    flue_ratio = 2,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "raw-gas",
    flue_ratio = 0.4,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "middle-oil",
    flue_ratio = 0.6,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "dirty-syngas",
    flue_ratio = 1,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "condensates",
    flue_ratio = 0.4,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "coalbed-gas",
    flue_ratio = 0.2,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "coal-gas",
    flue_ratio = 0.4,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "pitch",
    flue_ratio = 1,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "hydrogen",
    flue_ratio = 0,
    fuel_efficiency = 1,
    emissions_multiplier = 0
  },
  {
    fluid = "hot-residual-mixture",
    flue_ratio = 1,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "natural-gas",
    flue_ratio = 0.1,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
  {
    fluid = "crude-oil",
    flue_ratio = 0.8,
    fuel_efficiency = 1,
    emissions_multiplier = 1
  },
}

local function make_number(energy)
  local mult = energy:sub(tonumber(energy:sub(1,-2)) and -1 or -2, tonumber(energy:sub(1,-2)) and -1 or -2)
  return (tonumber(energy:sub(1,-2)) or tonumber(energy:sub(1,-3))) / (energy:sub(-1) == "W" and 60 or 1) * 10^(
    mult == "k" and 3 or mult == "M" and 6 or
    mult == "G" and 9 or mult == "T" and 12 or
    mult == "P" and 15 or mult == "E" and 18 or
    mult == "Z" and 21 or mult == "Y" and 24 or
    mult == "R" and 27 or mult == "Q" and 30 or 1
  )
end

local heat_capacity = make_number(data.raw.fluid.water.heat_capacity)
local steam_per_second = 60
local oil_per_craft = 5
local native_efficiency = 2.00

-- consumes 14.81 MW, ish
-- consumes 179.4/s (crude oil)
-- produces 60/s (steam)

for _, recipe in pairs(recipes) do
  
  fluid = data.raw.fluid[recipe.fluid]

  if not fluid then error(recipe.fluid) end

  local energy = make_number(fluid.fuel_value)
  
  -- water_per_craft * steam_temp_delta * energy_required per water deg C / energy_density of burned fluid
  -- also takes into account fuel efficiency
  -- steam_temp - 15, cause we're (probably) heating from 15C water
  -- oil-boiler had native 200% efficiency, so include that as well
  local seconds_per_craft = oil_per_craft / ((1 / native_efficiency) * (1 / recipe.fuel_efficiency) * ((steam_per_second) * 235 * heat_capacity / energy))

  RECIPE{
    type = "recipe",
    name = "oil-burning-" .. recipe.fluid,
    icons = {
      {
        icon = fluid.icon,
        icon_size = fluid.icon_size
      },
      {
        icon = data.raw.fluid.steam.icon,
        icon_size = data.raw.fluid.steam.icon_size,
        scale = 0.25,
        shift = {9, 9}
      }
    },
    icon_draw_specification = {
      shift = {0, 16},
      scale = 0.5
    },
    category = "oil-burning",
    enabled = false,
    hidden = false,
    energy_required = seconds_per_craft,
    ingredients = {
      {
        type = "fluid",
        name = "water",
        amount = steam_per_second * seconds_per_craft
      },
      {
        type = "fluid",
        name = recipe.fluid,
        amount = oil_per_craft
      }
    },
    results = {
      {
        type = "fluid",
        name = "steam",
        amount = steam_per_second * seconds_per_craft,
        temperature = recipe.steam_temp,
        fluidbox_index = 1
      },
      (recipe.flue_ratio and recipe.flue_ratio ~= 0) and {
        type = "fluid",
        name = recipe.flue_replacement or "flue-gas",
        amount = oil_per_craft * (recipe.flue_ratio or 1),
        fluidbox_index = 2
      } or nil
    },
    main_product = "steam",
    enabled = true,
    hide_from_player_crafting = true,
    emissions_multiplier = recipe.emissions_multiplier -- does nothing if it doesn't exist
  }
end

data.raw["assembling-machine"]["oil-boiler-mk01"] = table.deepcopy(data.raw.boiler["oil-boiler-mk01"])
data.raw.boiler["legacy-oil-boiler-mk01"] = table.deepcopy(data.raw.boiler["oil-boiler-mk01"])
data.raw.boiler["legacy-oil-boiler-mk01"].name = "legacy-oil-boiler-mk01"
data.raw.boiler["legacy-oil-boiler-mk01"].localised_name = {"", {"entity-name.oil-boiler-mk01"}, " (Legacy)"}
data.raw.boiler["oil-boiler-mk01"] = nil
ENTITY("oil-boiler-mk01"):set_fields{
  type = "assembling-machine",
  crafting_speed = 1,
  crafting_categories = { "oil-burning" },
  energy_usage = "1500kW",
  energy_source = {
    type = "electric",
    usage_priority = "secondary-input",
    emissions_per_minute = {
      pollution = 30
    },
    drain = "0W"
  },
  show_recipe_icon = false,
  allowed_effects = {"speed", "consumption", "pollution"},
  module_slots = 2,
  fluid_boxes = {
    {
      volume = 200,
      pipe_covers = py.pipe_covers(false, true, true, true),
      pipe_connections = {
        {flow_direction = "input-output", position = {-2.0, 0.0}, direction = defines.direction.west},
        {flow_direction = "input-output", position = {2.0, 0.0},  direction = defines.direction.east}
      },
      production_type = "input",
      volume_reservation_fraction = 0.5
    },
    {
      volume = 100,
      pipe_covers = py.pipe_covers(false, true, true, true),
      pipe_connections = {
        {flow_direction = "input", position = {-1.0, 2.0}, direction = defines.direction.south}
      },
      production_type = "input"
    },
    {
      volume = 100,
      pipe_covers = py.pipe_covers(false, true, true, true),
      pipe_connections = {
        {flow_direction = "output", position = {0.0, -2.0}, direction = defines.direction.north}
      },
      production_type = "output"
    },
    {
      volume = 100,
      pipe_covers = py.pipe_covers(false, true, true, true),
      pipe_connections = {
        {flow_direction = "output", position = {1.0, 2.0}, direction = defines.direction.south}
      },
      production_type = "output"
    }
  },
  graphics_set = {
    animation = {
      north = {
        filename = "__pypetroleumhandlinggraphics__/graphics/entity/oil-burner-mk01/off.png",
        priority = "extra-high",
        frame_count = 1,
        width = 196,
        height = 320,
        animation_speed = 0.4,
        -- repeat_count = 80,
        shift = util.by_pixel(18, -80)
      }
    },
    states = {
      {
        name = "idle",
        next_active = "working",
        next_inactive = "idle",
        duration = 1
      },
      {
        name = "working",
        next_active = "working",
        next_inactive = "idle",
        duration = 80
      }
    },
    working_visualisations = {
      {
        fadeout = true,
        animation = {
          layers = {
            {
              filename = "__pypetroleumhandlinggraphics__/graphics/entity/oil-burner-mk01/anim.png",
              priority = "extra-high",
              frame_count = 80,
              line_length = 10,
              width = 96,
              height = 128,
              animation_speed = 0.4,
              shift = util.by_pixel(-1, -176),
            },
            {
              filename = "__pypetroleumhandlinggraphics__/graphics/entity/py-converter-valve.png",
              priority = "extra-high",
              frame_count = 1,
              width = 64,
              height = 64,
              animation_speed = 0.4,
              repeat_count = 80,
              shift = util.by_pixel(-1, -6.5),
              --blend_mode = "additive",
          }
          }
        },
        draw_in_states = {"working"}
      }
    },
  }
}

data:extend{{
  type = "recipe-category",
  name = "oil-burning"
}}